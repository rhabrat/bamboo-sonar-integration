<?xml version="1.0" encoding="UTF-8"?>
<!--
 ~ Licensed to Marvelution under one or more contributor license 
 ~ agreements.  See the NOTICE file distributed with this work 
 ~ for additional information regarding copyright ownership.
 ~ Marvelution licenses this file to you under the Apache License,
 ~ Version 2.0 (the "License"); you may not use this file except
 ~ in compliance with the License.
 ~ You may obtain a copy of the License at
 ~
 ~  http://www.apache.org/licenses/LICENSE-2.0
 ~
 ~ Unless required by applicable law or agreed to in writing,
 ~ software distributed under the License is distributed on an
 ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 ~ KIND, either express or implied. See the License for the
 ~ specific language governing permissions and limitations
 ~ under the License.
 -->
<atlassian-plugin name="${atlassian.plugin.name}" key="${atlassian.plugin.key}" system="false" pluginsVersion="2">
	<plugin-info>
		<description>${project.description}</description>
		<vendor name="${project.organization.name}" url="${project.organization.url}" />
		<version>${project.version}</version>
		<application-version min="${atlassian.bamboo.version}" />
	</plugin-info>

	<!-- I 1 8 N   R E S O U R C E S -->
	<resource type="i18n" name="Sonar Tasks I18n" location="com.marvelution.bamboo.plugins.sonar.tasks.i18n"/>

	<!-- T A S K   T Y P E   D E F I N I T I O N S -->
	<taskType key="task.builder.sonar" name="Sonar Runner" class="com.marvelution.bamboo.plugins.sonar.tasks.SonarRunnerBuildTask">
		<description>Execute a Sonar Analysis using the Sonar Runner</description>
		<category name="builder"/>
		<category name="test"/>
		<executable key="snr" nameKey="task.builder.sonar.executableName" pathHelpKey="task.builder.sonar.helpPath"/>
		<capabilityDefaultsHelper class="com.marvelution.bamboo.plugins.sonar.tasks.SonarRunnerCapabilityDefaultsHelper"/>
		<configuration class="com.marvelution.bamboo.plugins.sonar.tasks.configuration.SonarRunnerBuildTaskConfigurator" />
		<resource type="freemarker" name="edit" location="com/marvelution/bamboo/plugins/sonar/tasks/configuration/sonarRunnerBuildTaskEdit.ftl"/>
		<resource type="freemarker" name="view" location="com/marvelution/bamboo/plugins/sonar/tasks/configuration/sonarRunnerBuildTaskView.ftl"/>
		<resource type="download" name="icon" location="icon.png"/>
	</taskType>
	<taskType key="task.builder.sonar2" name="Sonar Maven 2.x" class="com.marvelution.bamboo.plugins.sonar.tasks.SonarMaven2BuildTask">
		<description>Execute a Sonar Analysis using Maven 2.x</description>
		<category name="builder"/>
		<category name="test"/>
		<executable key="mvn2" nameKey="builder.maven2.executableName" pathHelpKey="builder.maven2.helpPath"/>
		<configuration class="com.marvelution.bamboo.plugins.sonar.tasks.configuration.SonarMaven2BuildTaskConfigurator" />
		<!-- Reuse the Maven 2 CapabilityHelper of Atlassian -->
		<capabilityDefaultsHelper class="com.atlassian.bamboo.plugins.maven.task.Maven2CapabilityDefaultsHelper"/>
		<resource type="freemarker" name="edit" location="com/marvelution/bamboo/plugins/sonar/tasks/configuration/sonarMaven2BuildTaskEdit.ftl"/>
		<resource type="freemarker" name="view" location="com/marvelution/bamboo/plugins/sonar/tasks/configuration/sonarMaven2BuildTaskView.ftl"/>
		<resource type="download" name="icon" location="icon.png"/>
	</taskType>
	<taskType key="task.builder.sonar3" name="Sonar Maven 3.x" class="com.marvelution.bamboo.plugins.sonar.tasks.SonarMaven3BuildTask">
		<description>Execute a Sonar Analysis using Maven 3.x</description>
		<category name="builder"/>
		<category name="test"/>
		<executable key="mvn3" nameKey="builder.maven3.executableName" pathHelpKey="builder.maven3.helpPath"/>
		<configuration class="com.marvelution.bamboo.plugins.sonar.tasks.configuration.SonarMaven3BuildTaskConfigurator" />
		<!-- Reuse the Maven 3 CapabilityHelper of Atlassian -->
		<capabilityDefaultsHelper class="com.atlassian.bamboo.plugins.maven.task.Maven3CapabilityDefaultsHelper"/>
		<resource type="freemarker" name="edit" location="com/marvelution/bamboo/plugins/sonar/tasks/configuration/sonarMaven3BuildTaskEdit.ftl"/>
		<resource type="freemarker" name="view" location="com/marvelution/bamboo/plugins/sonar/tasks/configuration/sonarMaven3BuildTaskView.ftl"/>
		<resource type="download" name="icon" location="icon.png"/>
	</taskType>

	<!-- T A S K   P R O C E S S   C O M M A N D   D E C O R A T O R   DE F I N I T I O N S -->
	<taskProcessCommandDecorator key="decorator.mavenSonarServerConfiguration" name="Sonar Maven Server Configuration Command Decorator"
			class="com.marvelution.bamboo.plugins.sonar.tasks.decorators.SonarMavenServerConfigurationCommandDecorator">
		<decoratedTaskType key="task.builder.sonar2" />
		<decoratedTaskType key="task.builder.sonar3" />
	</taskProcessCommandDecorator>
	<taskProcessCommandDecorator key="decorator.mavenSonarProjectConfiguration" name="Sonar Maven Project Configuration Command Decorator"
			class="com.marvelution.bamboo.plugins.sonar.tasks.decorators.SonarMavenProjectConfigurationCommandDecorator">
		<decoratedTaskType key="task.builder.sonar2" />
		<decoratedTaskType key="task.builder.sonar3" />
	</taskProcessCommandDecorator>
	<taskProcessCommandDecorator key="decorator.runnerSonarServerConfiguration" name="Sonar Runner Server Configuration Command Decorator"
			class="com.marvelution.bamboo.plugins.sonar.tasks.decorators.SonarRunnerServerConfigurationCommandDecorator">
		<decoratedTaskType key="task.builder.sonar" />
	</taskProcessCommandDecorator>
	<taskProcessCommandDecorator key="decorator.runnerSonarProjectConfiguration" name="Sonar Runner Project Configuration Command Decorator"
			class="com.marvelution.bamboo.plugins.sonar.tasks.decorators.SonarRunnerProjectConfigurationCommandDecorator">
		<decoratedTaskType key="task.builder.sonar" />
	</taskProcessCommandDecorator>

	<!-- W E B   R E S O U R C E S -->
	<web-resource key="publisher-specific" name="Publisher Specific Gadget Resources">
		<dependency>${atlassian.plugin.key}:commons</dependency>
		<dependency>com.atlassian.gadgets.publisher:ajs-gadgets-lite</dependency>
		<resource type="download" name="ajs-gadgets.js" location="/scripts/ajs-gadgets/ajs.gadgets-min.js">
			<property key="content-type" value="text/javascript" />
			<param name="source" value="webContextStatic" />
		</resource>
		<resource type="download" name="common.css" location="/styles/gadgets/common.css">
			<property key="content-type" value="text/css" />
			<param name="source" value="webContextStatic" />
		</resource>
	</web-resource>
	<web-resource key="commons" name="Common Web Resource Requirements">
		<dependency>com.atlassian.auiplugin:jquery</dependency>
		<dependency>com.atlassian.auiplugin:ajs</dependency>
		<resource type="download" name="namespace.js" location="/scripts/jquery/plugins/namespace/namespace-min.js">
			<property key="content-type" value="text/javascript"/>
            <param name="source" value="webContextStatic"/>
        </resource>
	</web-resource>
	<web-resource key="panel-css" name="Sonar Panel Resource Requirements">
		<resource type="download" name="panel.css" location="/com/marvelution/bamboo/plugins/sonar/tasks/styles/panel.css">
            <property key="content-type" value="text/css"/>
        </resource>
	</web-resource>
	<web-resource key="sonar-panel" name="Sonar Panel Resources">
		<dependency>${atlassian.plugin.key}:panel-css</dependency>
	</web-resource>

	<!-- W E B   P A N E L S -->
	<web-panel key="analysisOverviewPanel" location="sonar.web.panel.gadgets">
		<context-provider class="com.marvelution.bamboo.plugins.sonar.tasks.web.contextproviders.SonarConfigurationContextProvider" />
		<resource name="view" type="freemarker" location="/com/marvelution/bamboo/plugins/sonar/tasks/panels/analysisOverviewPanel.ftl" />
	</web-panel>
	<web-panel key="sonarTimeMachineChart" location="sonar.web.panel">
		<context-provider class="com.marvelution.bamboo.plugins.sonar.tasks.web.contextproviders.SonarTimeMachineChartContextProvider" />
		<resource name="view" type="freemarker" location="/com/marvelution/bamboo/plugins/sonar/tasks/panels/sonarTimeMachineChart.ftl" />
	</web-panel>

	<!-- W E B   S E C T I O N S -->
	<web-section key="sonar" name="Sonar" location="system.admin" weight="75">
		<label key="websections.system.admin.sonar"/>
	</web-section>

	<!-- A D M I N   W E B   I T E M S -->
	<web-item key="viewSonarGadgets" name="Sonar Gadgets" section="system.admin/sonar" weight="30">
		<label key="webitems.system.admin.sonar.view.gadgets" />
		<link linkId="viewSonarGadgets">/admin/sonar/viewSonarGadgets.action</link>
	</web-item>

	<!-- W E B   I T E M S -->
	<web-item key="sonar:${plan.key}-${resultsSummary.buildNumber}" name="sonar" section="chainResults.subMenu/chainResults" weight="100">
		<label key="Sonar" />
		<link linkId="sonar:${plan.key}-${resultsSummary.buildNumber}">/chain/result/viewChainSonarResult.action?planKey=${plan.key}&amp;buildNumber=${resultsSummary.buildNumber}</link>
		<condition class="com.marvelution.bamboo.plugins.sonar.tasks.web.conditions.SonarResultWebItemCondition" />
	</web-item>
	<web-item key="sonar:${buildKey}-${buildNumber}" name="sonar" section="results.subMenu/results" weight="100">
		<label key="Sonar" />
		<link linkId="sonar:${buildKey}-${buildNumber}">/build/result/viewBuildSonarResult.action?buildKey=${buildKey}&amp;buildNumber=${buildNumber}</link>
		<condition class="com.marvelution.bamboo.plugins.sonar.tasks.web.conditions.SonarResultWebItemCondition" />
	</web-item>

	<!-- A D M I N   X W O R K   A C T I O N S -->
	<xwork key="sonarConfigExtra" name="Extra Sonar Admin Actions">
		<package name="sonarAdminExtra" extends="admin" namespace="/admin/sonar">
			<action name="viewSonarGadgets" class="com.marvelution.bamboo.plugins.sonar.tasks.web.actions.admin.ViewSonarGadgets" method="default">
				<result name="input" type="freemarker">/com/marvelution/bamboo/plugins/sonar/tasks/actions/admin/viewSonarGadgets.ftl</result>
				<result name="success" type="freemarker">/com/marvelution/bamboo/plugins/sonar/tasks/actions/admin/viewSonarGadgets.ftl</result>
			</action>
		</package>
	</xwork>

	<!-- X W O R K   A C T I O N S -->
	<xwork key="sonarWebActions" name="Sonar Web Actions">
		<package name="sonarChainView" extends="chainViewResult">
			<action name="viewChainSonarResult" class="com.marvelution.bamboo.plugins.sonar.tasks.web.actions.chain.ViewChainSonarResult">
				<param name="chainEquiv">/chain/result/viewChainSonarResult.action?planKey=${planKey}&amp;buildNumber=${buildNumber}</param>
				<param name="jobEquiv">/build/result/viewBuildSonarResult.action?planKey=${planKey}&amp;buildNumber=${buildNumber}</param>
				<result name="success" type="freemarker">/com/marvelution/bamboo/plugins/sonar/tasks/actions/chain/viewChainSonarResult.ftl</result>
				<result name="error" type="freemarker">/error.ftl</result>
			</action>
		</package>
		<package name="sonarBuildView" extends="buildResultView">
			<action name="viewBuildSonarResult" class="com.marvelution.bamboo.plugins.sonar.tasks.web.actions.build.ViewBuildSonarResult">
				<param name="chainEquiv">/chain/result/viewChainSonarResult.action?planKey=${planKey}&amp;buildNumber=${buildNumber}</param>
				<param name="jobEquiv">/build/result/viewBuildSonarResult.action?planKey=${planKey}&amp;buildNumber=${buildNumber}</param>
				<result name="success" type="freemarker">/com/marvelution/bamboo/plugins/sonar/tasks/actions/build/viewBuildSonarResult.ftl</result>
				<result name="error" type="freemarker">/error.ftl</result>
			</action>
		</package>
		<package name="metricsFragments" extends="buildView" namespace="/sonar/ajax">
			<action name="addMetrics" class="com.marvelution.bamboo.plugins.sonar.tasks.web.actions.metrics.EditMetrics" method="addMetrics">
				<result name="success" type="freemarker">/com/marvelution/bamboo/plugins/sonar/tasks/actions/metrics/metricView.ftl</result>
				<result name="input" type="freemarker">/com/marvelution/bamboo/plugins/sonar/tasks/actions/metrics/metricInput.ftl</result>
				<result name="error" type="json" />
			</action>
			<action name="viewMetrics" class="com.marvelution.bamboo.plugins.sonar.tasks.web.actions.metrics.EditMetrics" method="default">
				<result name="input" type="freemarker">/com/marvelution/bamboo/plugins/sonar/tasks/actions/metrics/metricView.ftl</result>
			</action>
			<action name="editMetrics" class="com.marvelution.bamboo.plugins.sonar.tasks.web.actions.metrics.EditMetrics" method="default">
				<result name="input" type="freemarker">/com/marvelution/bamboo/plugins/sonar/tasks/actions/metrics/metricInput.ftl</result>
			</action>
			<action name="deleteMetric" class="com.marvelution.bamboo.plugins.sonar.tasks.web.actions.metrics.EditMetrics" method="deleteMetric">
				<result name="success" type="freemarker">/com/marvelution/bamboo/plugins/sonar/tasks/actions/metrics/metricView.ftl</result>
			</action>
		</package>
	</xwork>

	<!-- C O M P O N E N T S -->
	<component key="sonarMetricsManager" name="Sonar Metrics Manager" class="com.marvelution.bamboo.plugins.sonar.tasks.web.metrics.DefaultSonarMetricsManager">
		<interface>com.marvelution.bamboo.plugins.sonar.tasks.web.metrics.SonarMetricsManager</interface>
	</component>

</atlassian-plugin>
